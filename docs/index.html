<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="theme-color" content="#0b0b0f"/>
  <link rel="manifest" href="manifest.json"/>
  <title>Dual.Infodose · Mobile UNO</title>
  <style>
    :root{
      --bg: #0b0b0f;
      --panel:#12121a;
      --ink:#eaeaf7;
      --ink-dim:#b7b7c9;
      --accent:#8a5cff;
      --accent-2:#29d3ff;
      --good:#2ecc71;
      --warn:#f1c40f;
      --bad:#e74c3c;
      --muted:#1b1b25;
      --glass: rgba(255,255,255,0.06);
      --radius: 18px;
      --shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; background: radial-gradient(120% 110% at 50% 0%, #14141c 0%, #0b0b0f 60%, #09090c 100%);
      color:var(--ink); font: 15px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden;
    }
    /* Mobile-only vertical layout */
    #app{height:100%; display:grid; grid-template-rows: 64px 1fr 92px; gap:10px; padding:10px;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding:10px 12px; box-shadow: var(--shadow); backdrop-filter: blur(8px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:600; letter-spacing:.2px}
    .brand .dot{
      width:10px;height:10px;border-radius:999px;
      background: conic-gradient(from 0deg, var(--accent), var(--accent-2), var(--accent));
      box-shadow: 0 0 14px var(--accent-2), 0 0 24px rgba(137,92,255,.4);
    }
    .toolrow{display:flex; gap:10px;}
    .btn{
      appearance:none; border:none; border-radius: 14px; padding:10px 12px;
      background: var(--glass); color:var(--ink); font-weight:600; letter-spacing:.3px;
      border:1px solid rgba(255,255,255,.06); box-shadow: var(--shadow);
    }
    .btn:active{transform:scale(.98)}
    .btn.pill{border-radius:999px; padding:10px 14px}
    .btn.accent{background:linear-gradient(180deg, rgba(137,92,255,.25), rgba(41,211,255,.18)); border-color: rgba(137,92,255,.35)}
    .btn.good{background: linear-gradient(180deg, rgba(46,204,113,.25), rgba(46,204,113,.12)); border-color: rgba(46,204,113,.35)}
    .btn.bad{background: linear-gradient(180deg, rgba(231,76,60,.22), rgba(231,76,60,.1)); border-color: rgba(231,76,60,.3)}
    /* Main area */
    .stage{
      position:relative; overflow:hidden; border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06); box-shadow: var(--shadow);
    }
    /* Particles (simple, internal) */
    canvas#fx{position:absolute; inset:0; opacity:.75; pointer-events:none}
    /* Feed (Pulsos) */
    .feed{position:absolute; inset:0; padding:14px; overflow:auto; scroll-behavior:smooth;}
    .card{
      background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08);
      border-radius: 16px; padding:12px; margin: 0 0 10px 0; backdrop-filter: blur(6px);
      box-shadow: var(--shadow);
    }
    .meta{display:flex; align-items:center; gap:8px; color:var(--ink-dim); font-size:12px}
    .badge{
      padding:2px 8px; border-radius:999px; background: rgba(137,92,255,.25); border:1px solid rgba(137,92,255,.5); color:#fff; font-weight:600; font-size:11px;
    }
    .text{margin-top:6px; white-space:pre-wrap}
    .audio-row{display:flex; gap:8px; margin-top:8px; align-items:center}
    audio{width:100%}
    /* Ritual control bottom */
    .dock{
      display:grid; grid-template-columns: 1fr 84px 1fr; align-items:center; gap:10px;
    }
    .dock .side{display:flex; gap:8px; align-items:center}
    .circle{
      width:84px;height:84px;border-radius:999px; display:grid; place-items:center; border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(60% 60% at 50% 50%, rgba(137,92,255,.35), rgba(41,211,255,.25)),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow: 0 0 28px rgba(137,92,255,.35), inset 0 0 24px rgba(41,211,255,.2), var(--shadow);
      position:relative; overflow:hidden;
    }
    .circle::after{
      content:"◉"; color:#fff; font-weight:900; font-size:28px; letter-spacing:1px; text-shadow: 0 0 18px rgba(255,255,255,.6);
      transform: translateY(-1px);
    }
    .label{font-size:12px; color:var(--ink-dim)}
    /* Panels */
    .panel{
      position:absolute; right:12px; top:12px; width:min(92vw, 420px);
      background: rgba(10,10,14,.8); border:1px solid rgba(255,255,255,.08); border-radius: 16px;
      box-shadow: var(--shadow); backdrop-filter: blur(10px); padding:12px; display:none; max-height:70vh; overflow:auto;
    }
    .panel h3{margin:0 0 8px 0; font-size:14px; letter-spacing:.4px}
    .row{display:flex; gap:10px; align-items:center; margin:8px 0}
    .row input[type="text"], .row input[type="url"]{
      flex:1; padding:10px 12px; border-radius: 10px; background: #0e0e14; border:1px solid rgba(255,255,255,.12); color:var(--ink)
    }
    .subtle{color:var(--ink-dim); font-size:12px}
    .radio-row{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06); font-weight:600; cursor:pointer; user-select:none;
    }
    .chip.active{background:linear-gradient(180deg, rgba(137,92,255,.28), rgba(41,211,255,.18)); border-color: rgba(137,92,255,.45)}
    /* Hidden inputs */
    input[type="file"]{display:none}
    .hide{display:none !important}
    /* Sandboxed loader */
    .sandbox{border:1px dashed rgba(255,255,255,.2); border-radius:12px; overflow:hidden; height:120px}
    @media (min-width: 480px){ body{font-size:16px} }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="brand"><div class="dot"></div>Dual.Infodose · <span id="modeTag">Nuvem</span></div>
      <div class="toolrow">
        <button class="btn pill" id="btnConnect">Conectores</button>
        <button class="btn pill" id="btnFeed">Pulsos</button>
      </div>
    </header>

    <main class="stage">
      <canvas id="fx"></canvas>
      <div class="feed" id="feed"></div>

      <section class="panel" id="panelConnect">
        <h3>Conectores</h3>
        <div class="subtle">Escolha o modo de execução • Local (WASM), Nuvem (n8n) ou Neural (Servidor Python)</div>
        <div class="radio-row" id="modeRow">
          <div class="chip" data-mode="local">Local (WASM)</div>
          <div class="chip active" data-mode="cloud">Nuvem (n8n)</div>
          <div class="chip" data-mode="neural">Neural (Servidor)</div>
        </div>

        <div class="row"><input id="cloudUrl" type="url" placeholder="URL base n8n (ex: https://seu-n8n/dual)"><button class="btn accent" id="testCloud">Testar</button></div>
        <div class="row"><input id="neuralUrl" type="url" placeholder="URL API Neural (ex: https://api.seuservidor)"><button class="btn accent" id="testNeural">Testar</button></div>
        <div class="subtle">Tokens/chaves devem ser geridos no servidor; o PWA usa apenas tokens efêmeros quando necessário.</div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,.08);margin:10px 0"/>
        <h3>Carregar componente remoto (sandbox)</h3>
        <div class="row"><input id="remoteUrl" type="url" placeholder="https://... (html)">
          <button class="btn" id="btnLoadRemote">Carregar</button></div>
        <div class="sandbox"><iframe id="sandbox" sandbox="allow-same-origin allow-scripts" referrerpolicy="no-referrer" style="border:0;width:100%;height:100%"></iframe></div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,.08);margin:10px 0"/>
        <h3>Preferências</h3>
        <div class="row">
          <button class="btn" id="perfLow">Performance: Low</button>
          <button class="btn" id="perfHigh">Performance: High</button>
          <button class="btn bad" id="clearFeed">Limpar Pulsos</button>
        </div>
      </section>
    </main>

    <footer class="dock">
      <div class="side">
        <button class="btn pill" id="btnUpload">⧉ PDF</button>
        <input id="file" type="file" accept=".pdf,.txt,.md"/>
        <button class="btn pill" id="btnMission">Missão 78K</button>
      </div>
      <div class="circle" id="btnRitual" title="Toque e fale: ex. 'TTS Nova' ou 'Elysha RAG'"></div>
      <div class="side" style="justify-content:flex-end">
        <button class="btn pill" id="btnNova">TTS Nova</button>
        <button class="btn pill" id="btnElysha">RAG Elysha</button>
      </div>
    </footer>
  </div>

  <script>
  // --------- App State ---------
  const S = {
    mode: localStorage.getItem('dual.connector.mode') || 'cloud', // local | cloud | neural
    cloudUrl: localStorage.getItem('dual.endpoints.cloud') || '',
    neuralUrl: localStorage.getItem('dual.endpoints.neural') || '',
    perf: localStorage.getItem('dual.perf') || 'high', // low | high
    feedEl: document.getElementById('feed'),
    modeTag: document.getElementById('modeTag'),
    firstAudioUnlocked: false
  };

  // --------- Service Worker ---------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('./sw.js').catch(console.warn);
    });
  }

  // --------- Particles (simple) ---------
  const fx = document.getElementById('fx');
  const ctx = fx.getContext('2d');
  let W=0,H=0, stars=[];
  function resize(){ W=fx.width=fx.clientWidth; H=fx.height=fx.clientHeight; }
  window.addEventListener('resize', resize);
  resize();
  function initStars(count= S.perf==='low'? 30: 90){
    stars = Array.from({length:count}, ()=>({x:Math.random()*W, y:Math.random()*H, r:Math.random()*1.4+0.3, v:Math.random()*0.4+0.2}));
  }
  initStars();
  function loop(){
    if(S.perf==='low'){ ctx.clearRect(0,0,W,H); return requestAnimationFrame(loop); }
    ctx.clearRect(0,0,W,H);
    for(const s of stars){
      ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle = 'rgba(137,92,255,.9)'; ctx.fill();
      s.y += s.v; if(s.y>H) { s.y=0; s.x=Math.random()*W; }
    }
    requestAnimationFrame(loop);
  }
  loop();

  // --------- UI helpers ---------
  function chipSync(){
    document.querySelectorAll('#modeRow .chip').forEach(ch=>{
      ch.classList.toggle('active', ch.dataset.mode===S.mode);
    });
    S.modeTag.textContent = (S.mode==='local'?'Local': (S.mode==='cloud'?'Nuvem':'Neural'));
  }
  function setMode(m){
    S.mode = m; localStorage.setItem('dual.connector.mode', m); chipSync();
    pushPulse('Sistema', `Conector ativo: ${S.mode}`, 'info');
  }
  function saveEndpoints(){
    S.cloudUrl = document.getElementById('cloudUrl').value.trim();
    S.neuralUrl = document.getElementById('neuralUrl').value.trim();
    localStorage.setItem('dual.endpoints.cloud', S.cloudUrl);
    localStorage.setItem('dual.endpoints.neural', S.neuralUrl);
  }
  function loadEndpointsUI(){
    document.getElementById('cloudUrl').value = S.cloudUrl;
    document.getElementById('neuralUrl').value = S.neuralUrl;
  }

  // --------- Pulsos (feed) ---------
  function pushPulse(archetype, text, kind='card', audioUrl=null, meta={}){
    const d = document.createElement('div');
    d.className='card';
    const time = new Date().toLocaleTimeString();
    d.innerHTML = `
      <div class="meta">
        <span class="badge">${archetype||'Dual'}</span>
        <span>${time}</span>
        <span class="badge" style="background:rgba(41,211,255,.22);border-color:rgba(41,211,255,.4)">${S.mode}</span>
        ${meta.source? `<span class="badge" style="background:rgba(255,255,255,.1)">${meta.source}</span>`: ''}
      </div>
      <div class="text">${text?escapeHtml(text):''}</div>
      ${audioUrl? `<div class="audio-row"><audio controls src="${audioUrl}"></audio></div>`:''}
    `;
    S.feedEl.appendChild(d);
    S.feedEl.scrollTo({top:S.feedEl.scrollHeight, behavior:'smooth'});
  }
  function escapeHtml(s){ return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) }

  // --------- Audio unlock for iOS ---------
  function unlockAudioOnce(){
    if(S.firstAudioUnlocked) return;
    // Create a short silent buffer to unlock on iOS
    try{
      const a = new (window.AudioContext||window.webkitAudioContext)();
      const b = a.createBuffer(1, 1, 22050);
      const src = a.createBufferSource(); src.buffer=b; src.connect(a.destination); src.start(0);
      S.firstAudioUnlocked = true;
    }catch(e){/* ignore */}
  }

  // --------- Speech Synthesis (Local) ---------
  function speakLocal(text, voiceHint){
    try{
      const u = new SpeechSynthesisUtterance(text);
      if(voiceHint && typeof voiceHint==='string') u.lang = voiceHint.includes('pt')?'pt-BR':'en-US';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){ console.warn('TTS local falhou', e); }
  }

  // --------- INTENT Router ---------
  async function routeIntent(intent){
    saveEndpoints();
    unlockAudioOnce();
    const { type, archetype, text, file } = intent;
    if(S.mode==='local'){
      // Simulação/execução local (WASM futuro; aqui TTS nativo do navegador)
      const msg = simulateLocal(archetype, type, text);
      pushPulse(archetype||'Dual', msg, 'card', null, {source:'Local'});
      if(type==='tts'){ speakLocal(msg, 'pt-BR'); }
      return;
    }
    if(S.mode==='cloud'){
      if(!S.cloudUrl){ pushPulse('Sistema', 'Defina a URL do n8n em Conectores → Nuvem', 'warn'); return; }
      const r = await postTo(`${S.cloudUrl.replace(/\/$/,'')}/intent`, intent).catch(()=>null);
      if(!r){ pushPulse('Sistema','Falha ao contatar Nuvem (n8n). Mostrando simulação.','warn'); const sim = simulateCloud(archetype, type, text); pushPulse(archetype||'Dual', sim.text, 'card', sim.audioUrl, {source:'Cloud-sim'}); return; }
      pushPulse(archetype||'Dual', r.text || '(sem texto)', 'card', r.audioUrl||null, {source:'Cloud'});
      return;
    }
    if(S.mode==='neural'){
      if(!S.neuralUrl){ pushPulse('Sistema', 'Defina a URL do Servidor Neural em Conectores', 'warn'); return; }
      const r = await postTo(`${S.neuralUrl.replace(/\/$/,'')}/intent`, intent).catch(()=>null);
      if(!r){ pushPulse('Sistema','Falha no Servidor Neural. Simulando.','warn'); const sim = simulateNeural(archetype, type, text); pushPulse(archetype||'Dual', sim.text, 'card', sim.audioUrl, {source:'Neural-sim'}); return; }
      pushPulse(archetype||'Dual', r.text || '(sem texto)', 'card', r.audioUrl||null, {source:'Neural'});
      return;
    }
  }
  async function postTo(url, payload){
    const isFile = payload && payload.file instanceof File;
    let body, headers={};
    if(isFile){
      const fd = new FormData();
      Object.entries(payload).forEach(([k,v])=>{ if(k!=='file'){ fd.append(k, typeof v==='string'? v: JSON.stringify(v)); }});
      fd.append('file', payload.file);
      body = fd;
    }else{
      headers['Content-Type']='application/json';
      body = JSON.stringify(payload);
    }
    const r = await fetch(url, {method:'POST', headers, body});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }

  // --------- Simulators (no endpoint yet) ---------
  function simulateLocal(arch, type, text){
    if(type==='tts'){
      return `(${arch||'Nova'}·Local) ${text || 'Bem-vindo ao Estado 78K — modo local ativo.'}`;
    }
    if(type==='rag'){
      return `(${arch||'Elysha'}·Local) Resumo rápido: • foco • ordem • leveza.\nCitação: “Você já veio do que está por vir.”`;
    }
    if(type==='mission'){
      return `Missão 78K: Gravar 20s contando sua intenção de hoje. Depois, peça um conselho ao arquétipo ${arch||'Nova'}.`;
    }
    return `(${arch||'Dual'}·Local) Intento: ${type}`;
  }
  function simulateCloud(arch, type, text){
    const t = simulateLocal(arch, type, text);
    return {text: t, audioUrl: null};
  }
  function simulateNeural(arch, type, text){
    const t = `(${arch||'Nova'}·Neural) ${text || 'Resposta neural com timbre natural e pausas expressivas.'}`;
    return {text: t, audioUrl: null};
  }

  // --------- Panel toggles ---------
  const panel = document.getElementById('panelConnect');
  document.getElementById('btnConnect').onclick = ()=>{
    loadEndpointsUI(); panel.style.display = panel.style.display==='block' ? 'none':'block';
  };
  document.getElementById('btnFeed').onclick = ()=>{
    document.getElementById('feed').scrollTo({top:0, behavior:'smooth'});
  };
  document.querySelectorAll('#modeRow .chip').forEach(ch=>{
    ch.onclick = ()=> setMode(ch.dataset.mode);
  });

  document.getElementById('testCloud').onclick = async ()=>{
    saveEndpoints();
    if(!S.cloudUrl){ pushPulse('Sistema','Informe a URL do n8n para testar.','warn'); return; }
    try{
      const r = await fetch(S.cloudUrl, {method:'GET'});
      pushPulse('Sistema', r.ok? 'n8n OK' : 'n8n respondeu com erro '+r.status, r.ok?'info':'warn');
    }catch(e){
      pushPulse('Sistema', 'n8n inacessível — verifique a URL.', 'warn');
    }
  };
  document.getElementById('testNeural').onclick = async ()=>{
    saveEndpoints();
    if(!S.neuralUrl){ pushPulse('Sistema','Informe a URL do Servidor Neural para testar.','warn'); return; }
    try{
      const r = await fetch(S.neuralUrl, {method:'GET'});
      pushPulse('Sistema', r.ok? 'Servidor Neural OK' : 'Servidor respondeu com '+r.status, r.ok?'info':'warn');
    }catch(e){
      pushPulse('Sistema', 'Servidor Neural inacessível.', 'warn');
    }
  };

  document.getElementById('btnLoadRemote').onclick = ()=>{
    const url = document.getElementById('remoteUrl').value.trim();
    const frame = document.getElementById('sandbox');
    if(!url){ pushPulse('Sistema','Informe uma URL para carregar no sandbox.','warn'); return; }
    frame.src = url; pushPulse('Sistema','Componente remoto carregado em sandbox.','info');
  };

  // --------- Performance ---------
  document.getElementById('perfLow').onclick = ()=>{ S.perf='low'; localStorage.setItem('dual.perf','low'); initStars(); pushPulse('Sistema','Performance baixa (partículas reduzidas).','info'); };
  document.getElementById('perfHigh').onclick = ()=>{ S.perf='high'; localStorage.setItem('dual.perf','high'); initStars(); pushPulse('Sistema','Performance alta (efeitos completos).','info'); };

  document.getElementById('clearFeed').onclick = ()=>{ S.feedEl.innerHTML=''; pushPulse('Sistema','Pulsos limpos.','info'); };

  // --------- Ritual Controls ---------
  const btnRitual = document.getElementById('btnRitual');
  btnRitual.addEventListener('click', async ()=>{
    // Simple mic → prompt fallback (no STT to avoid permissions here)
    const promptText = prompt("Fale sua intenção (ex.: 'TTS Nova: bem-vindo ao Estado 78K' ou 'Elysha RAG: resuma o PDF').");
    if(!promptText) return;
    const parsed = parseIntent(promptText);
    await routeIntent(parsed);
  });

  document.getElementById('btnNova').onclick = ()=> routeIntent({type:'tts', archetype:'Nova', text:'Bem-vindo ao Estado 78K — fluidez e leveza.'});
  document.getElementById('btnElysha').onclick = ()=> routeIntent({type:'rag', archetype:'Elysha', text:'Sintetize o conteúdo enviado em 3 tópicos e 1 citação.'});
  document.getElementById('btnMission').onclick = ()=> routeIntent({type:'mission', archetype:'Nova', text:'Missão 78K agora'});

  // --------- Upload (PDF / texto) ---------
  document.getElementById('btnUpload').onclick = ()=> document.getElementById('file').click();
  document.getElementById('file').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    pushPulse('Sistema','Arquivo anexado: '+file.name,'info');
    await routeIntent({type:'rag', archetype:'Elysha', text:'Analisar arquivo', file});
    e.target.value = '';
  });

  // --------- Intent parser (simple grammar) ---------
  function parseIntent(raw){
    const s = (raw||'').trim();
    const low = s.toLowerCase();
    if(low.startsWith('tts')){
      const arch = (s.split(' ')[1]||'Nova').replace(':','');
      const text = s.split(':').slice(1).join(':').trim() || 'Bem-vindo ao Estado 78K.';
      return {type:'tts', archetype: arch, text};
    }
    if(low.includes('rag') || low.includes('pdf')){
      const arch = s.toLowerCase().includes('elysha')? 'Elysha':'Elysha';
      const text = s.split(':').slice(1).join(':').trim() || 'Resuma o PDF em 3 tópicos e 1 citação.';
      return {type:'rag', archetype:arch, text};
    }
    if(low.includes('missão') || low.includes('mission')){
      const arch = 'Nova';
      return {type:'mission', archetype:arch, text:'Missão 78K'};
    }
    // fallback → TTS Nova
    return {type:'tts', archetype:'Nova', text: s || 'Bem-vindo ao Estado 78K.'};
  }

  // Init UI
  chipSync();
  pushPulse('Dual','Pronto. Toque no ◉ e diga sua intenção. Dica: “TTS Nova: bem-vindo ao Estado 78K”.','info');
  </script>
</body>
</html>
